# 概要
ESP32のBLEでアプリケーションの変更可能パラメータを設定する方法

# 参考
- [ESP32でJTAGデバッグ](https://ippei8jp.github.io/memoBlog/2021/12/27/ESP32_JTAG.html)
  - プロジェクトの作成～JTAGデバッグについて一通り試しています

# 何してるの？
プログラムを実行する際、実行環境毎に設定を変更したい場合って結構ありますよね。  
複数台を同時に運用する場合に個々のマシン名を変更したり、運用場所によってWi-FiのAPを変更したり。  
そんなとき、いままではシリアルコンソールから設定モードに入ってシリアル入力でパラメータ入力してたのですが、  
実装スペースの関係からシリアルコンソールが接続できない場合などに、なにか良い手はないかと考え、  
BLEで設定する方法を試してみました。  

> 今回はデバッグ用にシリアルコンソール繋いであるので設定モードに入るためにシリアル入力を使っていますが、  
> これはスイッチなどで代用できるので気にしないでください。  

# 手順
VScode + platformioでの作業を想定  
- リポジトリをclone  
- VScodeでPlatformIO HomeからOpen Projectでcloneしたディレクトリを開く  
- menuconfigは変更済み  
  - 以下変更時の手順(参考)  
    - (Top) → Component config → Bluetooth を選択  
    - Bluetoothを選択して有効化  

> menuconfigの変更方法
> - PlatformIOサイドバーでPROJECT TASKS→esp32dev→Platform→Run Menuconfig を選択するとターミナルウィンドウでMenuconfigが実行される
>   - ターミナルウィンドウをクリックしてフォーカスをあてる(忘れがち!!)
>   - ｊキーで下、kキーで上にカーソルが移動する。(カーソルキーでは動かない!!)
>   - CRまたはスペースで選択
>   - ESCで前の画面に戻る
>   - トップ画面でESC入力で``Save configuration?``と聞かれるので良きにはからってちょ

- Build & Upload(またはdebug)  
- ESP32にシリアルコンソール接続  
- シリアルコンソールに``==== enter to setting mode? ====``と表示されたら、``....``が表示されている間(5秒間)のうちに何かキーを入力  
  - NVSからの読み込みに失敗した場合やNVSに有効な値がセットされていなかった場合はキー入力待ちせずに以下に進む  
- BLEの初期化が行われ、advertisingモードに入る(接続待ち)  
- RaspberryPi等ホストマシンでhost_tool/SetAppPaeam.py を実行してパラメータを設定  
```
python SetAppPaeam.py «SSID名» «SSIDパスワード» «インターバル値(0以外)»
```
- ホストマシンから設定済みのパラメータを確認するには、引数なしでスクリプトを実行  
```
python SetAppPaeam.py
```
> python環境のセットアップについては[pythonでBLE](https://ippei8jp.github.io/memoBlog/2022/01/31/ESP32_BLE_4.html)を参照   

- シリアルコンソールで``p``(小文字)を入力するとパラメータが表示されるので、設定値が正しいことを確認する  
  - 正しくなければ再度ホストマシンからpythonスクリプトを実行(パラメータが間違ってたハズ)  
- シリアルコンソールで``q``(小文字)を入力するしてループを抜ける  
- シリアルコンソールで``s``(小文字)を入力するして設定したパラメータをnvsに保存する  
  - nvsは別タスクで動いているハズなのですぐリブートするとまずいかも。  
    ちゃんと書き込みシーケンスの表示を確認した方が良いかも。  
- シリアルコンソールで``r``(小文字)を入力するしてシステムをリブートする  
- シリアルコンソールに``==== enter to setting mode? ====``と表示されたら、``....``に表示が終わる(5秒間)まで待つ  
- Wi-Fi アクセスポイントに接続される  
- ホストマシンやWindowsマシンからpingを打ってみて応答があることを確認  

